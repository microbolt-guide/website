import { Steps, Tabs } from 'nextra/components'
import { FAQBox } from '@components'

export const name = "Electrs"
export const user = "electrs"

[security section]: ../../system/security#reverse-proxy
[release notes]: https://github.com/romanz/electrs/releases
[{name}]: ./electrs

# Electrs

We set up [{name}](https://github.com/romanz/electrs) to serve as a full
Electrum server for use with your Bitcoin software or hardware signing device.

![Electrs logo](/img/bitcoin/electrum-server/electrs.webp)

## Preparations

<Steps>
### Install dependencies

These are build dependencies (safe to remove after installation, if you want)

```sh copy
$SU apk add --virtual .build-deps cargo cargo-auditable clang-dev cmake git \
    gnupg rocksdb-dev
```

These are runtime dependencies

```sh copy
$SU apk add rocksdb
```

### Create the {user} user/group

```sh copy
$SU addgroup -S electrs
```

```sh copy
$SU adduser \
    -S \
    -D \
    -H \
    -h /dev/null \
    -s /sbin/nologin \
    -G electrs \
    -g electrs \
    electrs
```

### Add {user} user to the bitcoind group

```sh copy
$SU adduser electrs bitcoind
```

### Add the user satoshi to the group {user} as well

```sh copy
$SU adduser satoshi electrs
```

### Reverse proxy

In the [security section], we set up a reverse proxy. Now we can add the {name}
configuration.

* Enable the reverse proxy to route external encrypted HTTPS traffic internally
to the {name}

<Tabs items={['caddy', 'nginx']}>
    <Tabs.Tab>
```sh copy
$SU $EDITOR /etc/caddy/streams/electrs.caddy
```

```nginx copy filename="/etc/caddy/streams/electrs.caddy"
:50012 {
        route {
                tls
                proxy {
                        upstream 127.0.0.1:50011
                }
        }
}
```

* Reload Caddy

```sh copy
$SU rc-service caddy reload
```
    </Tabs.Tab>
    <Tabs.Tab>
```sh copy
$SU $EDITOR /etc/nginx/streams-available/electrs-reverse-proxy.conf
```

```nginx copy filename="/etc/nginx/streams-available/electrs-reverse-proxy.conf"
upstream electrs {
  server 127.0.0.1:50011;
}

server {
  listen 50012 ssl;
  proxy_pass electrs;
}
```

```sh copy
$SU ln \
    -s \
    ../streams-available/electrs-reverse-proxy.conf \
    /etc/nginx/streams-enabled/electrs-reverse-proxy.conf
```

* Test and reload NGINX configuration

```sh copy
$SU nginx -t
$SU rc-service nginx restart
```
    </Tabs.Tab>
</Tabs>

### Firewall

* Configure the firewall to allow incoming requests

<Tabs items={['awall', 'ufw']}>
    <Tabs.Tab>
```sh copy
$SU $EDITOR /etc/awall/optional/electrs.json
```

```json copy filename="/etc/awall/optional/electrs.json"
{
  "description": "Allow Electrs SSL",

  "filter": [
    {
      "in": "internet",
      "out": "_fw",
      "service": "electrs",
      "action": "accept",
      "conn-limit": { "count": 10, "interval": 60 }
    }
  ]
}
```

* Enable it

```sh copy
$SU awall enable electrs
$SU awall activate
```
    </Tabs.Tab>
    <Tabs.Tab>
```sh copy
$SU ufw limit 50012/tcp comment 'Allow Electrs SSL'
```
    </Tabs.Tab>
</Tabs>
</Steps>

## Installation

An easy and performant way to run an Electrum server is to use
[{name}](https://github.com/romanz/electrs), the Electrum Server in Rust. There
are no binaries available, so we will compile the application ourselves.

<Steps>
### Download source code

We get the latest release of the {name} source code, verify it, compile it to
an executable binary and install it.

* Download the source code for the latest {name} release. You can check the
[release notes] to see if a newer release is available. Other releases might not
have been properly tested with the rest of the Microbolt configuration, though.

```sh copy
cd /tmp
```

```sh copy
VERSION=0.10.7
```

```sh copy
git clone --branch v$VERSION https://github.com/romanz/electrs.git && cd electrs
```

### Signature check

* To avoid using bad source code, verify that the release has been properly
signed by the main developer [Roman Zeyde](https://github.com/romanz).

```sh copy
curl -s https://romanzey.de/pgp.txt | gpg --import
```

```sh copy
git verify-tag v$VERSION
```

### Configure, compile and install

* Now compile the source code into an executable binary and install it. The
compilation process can take up to one hour.

```sh copy
cargo auditable build \
    --bin electrs \
    --features "metrics_process" \
    --release \
    --locked \
    --jobs "$(nproc)"
```

```sh copy
$SU install -m 0755 -o root -g root -t /usr/bin ./target/release/electrs
```

```sh copy
$SU install -D -m 0660 -o electrs -g electrs ./doc/config_example.toml /etc/electrs/main.toml
```

### Strip installed binaries

```sh copy
$SU strip -v /usr/bin/electrs
```

### Cleanup

```sh copy
cd
$SU rm -rf /tmp/electrs
$SU apk del .build-deps
```
</Steps>

## Configuration

* Modify the config file with the following content

```sh copy
$SU $EDITOR /etc/electrs/main.toml
```

```toml filename="/etc/electrs/main.toml" {2,4,6,8}
[...]
cookie_file = "/run/bitcoind/main.authcookie"
[...]
#db_dir = "/some/fast/storage/with/big/size"
[...]
electrum_rpc_address = "127.0.0.1:50011"
[...]
daemon_dir = "/var/lib/bitcoind/main"
```

<FAQBox title="Remote access over Tor">
To use your {name} when you're on the go, you can easily create a Tor hidden
service. This way, you can connect the BitBoxApp or Electrum wallet also
remotely, or even share the connection details with friends and family. Note
that the remote device needs to have Tor installed as well.

* Add the following lines in the section for "location-hidden services" in the
`torrc` file.

```sh copy
$SU $EDITOR /etc/tor/torrc
```

```sh copy filename="/etc/tor/torrc"
# Hidden Service Electrs
HiddenServiceDir /var/lib/tor/hsv3electrs/
HiddenServiceVersion 3
HiddenServicePoWDefensesEnabled 1
HiddenServicePort 50012 127.0.0.1:50012
```

* Reload Tor configuration and get your connection address.

```sh copy
$SU rc-service tor reload
```

```sh copy
$SU cat /var/lib/tor/hsv3electrs/hostname
```

```sh filename="output"
abcdefg..............xyz.onion
```

* You should now be able to connect to your {name} remotely via Tor using your
hostname and port `50012`
</FAQBox>

### Autostart on boot

{name} needs to start automatically on system boot.

* Create the {name} init.d unit and copy/paste the following configuration.
Save and exit.

```sh copy
$SU $EDITOR /etc/init.d/electrs
```

```sh copy filename="/etc/init.d/electrs"
#!/sbin/openrc-run

: ${ELECTRS_CHAIN:=main}
: ${ELECTRS_CONFIGFILE:=/etc/electrs/${ELECTRS_CHAIN}.toml}
: ${ELECTRS_DATADIR:=/var/lib/electrs/${ELECTRS_CHAIN}}
: ${ELECTRS_LOGDIR:=/var/log/electrs/${ELECTRS_CHAIN}}
: ${ELECTRS_USER:=electrs}
: ${ELECTRS_GROUP:=electrs}
: ${ELECTRS_BIN:=/usr/bin/electrs}
: ${ELECTRS_OPTS=${ELECTRS_OPTS}}
: ${ELECTRS_SIGTERM_TIMEOUT:=600}

required_files="${ELECTRS_CONFIGFILE}"
piddir="/run/electrs"
pidfile="${piddir}/${ELECTRS_CHAIN}.pid"
retry="${ELECTRS_SIGTERM_TIMEOUT}"

name="Electrs (${ELECTRS_CHAIN})"
description="Efficient re-implementation of Electrum Server in Rust"

command="${ELECTRS_BIN}"
command_args="--conf ${ELECTRS_CONFIGFILE}
              --skip-default-conf-files
              --db-dir ${ELECTRS_DATADIR}
              --skip-block-download-wait
              ${ELECTRS_OPTS}"
command_user="${ELECTRS_USER}:${ELECTRS_GROUP}"
command_background="true"

start_stop_daemon_args="--stdout ${ELECTRS_LOGDIR}/debug.log
                        --stderr ${ELECTRS_LOGDIR}/debug.log"

depend() {
    use bitcoind
    after bitcoind
    provide electrum
}

start_pre() {
    mkdir -p "${ELECTRS_DATADIR}" "${ELECTRS_LOGDIR}"
    checkpath --file      --mode 0660 --owner "${command_user}" "${ELECTRS_CONFIGFILE}"
    checkpath --directory --mode 0750 --owner "${command_user}" "${ELECTRS_DATADIR}"
    checkpath --directory --mode 0755 --owner "${command_user}" "${ELECTRS_LOGDIR}"
    checkpath --directory --mode 0755 --owner "${command_user}" "${piddir}"
    checkconfig
}

start_post() {
    checkpath --file --owner "${command_user}" "${pidfile}"
}

checkconfig() {
    if ! grep -qs '^cookie_file = ' "${ELECTRS_CONFIGFILE}"
    then
        eerror ""
        eerror "ERROR: You must set a cookie_file path to run Electrs."
        eerror "The setting must appear in ${ELECTRS_CONFIGFILE}"
        eerror ""
        return 1
    fi
}
```

* Enable execution permission

```sh copy
$SU chmod +x /etc/init.d/electrs
```

### Enable logrotate

* Enter the complete next configuration. Save and exit

```sh copy
$SU $EDITOR /etc/logrotate.d/electrs
```

```sh copy filename="/etc/logrotate.d/electrs"
/var/log/electrs/main/*.log {
    weekly
    missingok
    rotate 104
    compress
    delaycompress
    notifempty
    create 0640 electrs electrs
    sharedscripts
    postrotate
        kill -HUP `cat /run/electrs/main.pid`
    endscript
}
```

* Test

```sh copy
$SU logrotate /etc/logrotate.d/electrs --debug
```

## Enable and start {name}

```sh copy
$SU rc-update add electrs
```

```sh copy
$SU rc-service electrs start
```

* Check the log to see {name} output. Exit with `Ctrl-C`

```sh copy
tail -f /var/log/electrs/main/debug.log
```

{name} will now index the whole Bitcoin blockchain so that it can provide all
necessary information to signing devices. With this, the signing devices you use
no longer need to connect to any third-party server to communicate with the
Bitcoin peer-to-peer network.

## For the future: {name} upgrade

Follow again [{name}] page replacing the environment variable `VERSION=x.xx`
value for the latest if it has not been already changed in this guide.

* Update the {name} configuration if necessary (see [release notes])

```sh copy
$SU $EDITOR /etc/electrs/main.toml
```

* Restart the service to apply the changes

```sh copy
$SU rc-service electrs restart
```