import { Callout, Steps } from 'nextra/components'
import { FAQBox } from '@components'

# Elements

<Callout type="error">
This is a placeholder guide. It's not ready yet.
</Callout>

Elements by Blockstream is a client for the [Liquid
sidechain](https://liquid.net).

## Preparations

<Steps>
### Install dependencies

These are build dependencies (safe to remove after installation, if you want)

```sh copy
$SU apk add --virtual .build-deps autoconf automake boost-dev clang gnupg \
    libevent-dev libtool make pkgconf zeromq-dev
```

These are runtime dependencies
  
```sh copy
$SU apk add libboost libevent libzmq
```

### Create the `elements` user/group

```sh copy
$SU addgroup -S elements
```

```sh copy
$SU adduser \
    -S \
    -D \
    -H \
    -h /dev/null \
    -s /sbin/nologin \
    -G elements \
    -g elements \
    elements
```

### Add the user `satoshi` to the group `elements` as well
  
```sh copy
$SU adduser satoshi elements
```

### Create a symbolic link elements to `satoshi` home

```sh copy
ln -s /var/lib/elementsd "$HOME/.elements"
```
</Steps>

## Installation

We get the latest release of the elements source code, compile it to an
executable binary and install it.

<Steps>
### Download source code

* Login as `satoshi` and change to a temporary directory which is cleared on
reboot

```sh copy
cd /tmp
```

* Set a temporary version environment variable to the installation

```sh copy
VERSION=23.2.4
```

* Get the latest source code and signatures

```sh copy
wget https://github.com/ElementsProject/elements/releases/download/elements-$VERSION/elements-$VERSION.tar.gz \
    https://github.com/ElementsProject/elements/releases/download/elements-$VERSION/SHA256SUMS \
    https://github.com/ElementsProject/elements/releases/download/elements-$VERSION/SHA256SUMS.asc
```

### Checksum check

* Check that the reference checksum in the file SHA256SUMS matches the checksum calculated by you

```sh copy
grep elements-$VERSION.tar.gz SHA256SUMS | sha256sum -c
```

```sh filename="output"
elements-$VERSION.tar.gz: OK
```

### Signature check

Elements releases are signed by several individuals, each using its own key. To
verify the validity of these signatures, you must first import the corresponding
public keys into your GPG key database.

* The next commands downloads and imports automatically all signatures from the
Elements release repository

```sh copy
# Steven Roose PGP key
wget -qO- \
    "https://raw.githubusercontent.com/ElementsProject/elements/master/contrib/verify-commits/trusted-keys" |\
    while read -r fingerprint; do
        gpg \
            --keyserver hkps://keys.openpgp.org \
            --recv-keys "${fingerprint}"
    done
```

```sh copy
# Pablo Greco PGP key
wget -qO- \
    "https://github.com/psgreco.gpg" |\
    gpg --import
```

* Verify that the checksums file is cryptographically signed by the release
signing keys. The following command prints signature checks for each of the
public keys that signed the checksums

```sh copy
gpg --verify SHA256SUMS.asc
```

* Check that at least a few signatures show the following text

```sh filename="output"
gpg: Good signature from...
Primary key fingerprint:...
```

### Extract source

* If you’re satisfied with the checksum, and signature, extract the elements
source code

```sh copy
tar xzf elements-$VERSION.tar.gz && cd elements-$VERSION
```

### Configure, compile and install

<Callout type="info">
For convenience, it might be useful to have the manual page for `elements-cli`
in the same machine so that they can be consulted offline, it's installed by
default in this guide

If you **DON'T** want it, execute this

```sh copy
MAN=--disable-man
```
</Callout>

```sh copy
./autogen.sh
```

```sh copy
./configure \
    CXXFLAGS="${CXXFLAGS} -Wno-unused-result" \
    --prefix=/usr \
    "${MAN:---mandir=/usr/share/man}" \
    --with-daemon \
    --with-utils \
    --without-bdb \
    --without-sqlite \
    --without-miniupnpc \
    --without-natpmp \
    --without-qrencode \
    --without-gui \
    --without-libs \
    --without-qtdbus \
    --enable-hardening \
    --enable-liquid \
    --enable-lto \
    --enable-reduce-exports \
    --enable-static \
    --enable-zmq \
    --disable-bench \
    --disable-ccache \
    --disable-fuzz \
    --disable-fuzz-binary \
    --disable-gui-tests \
    --disable-maintainer-mode \
    --disable-shared \
    --disable-tests \
    --disable-wallet
```

```sh copy
make
```

```sh copy
$SU make install
[ -z $MAN ] && $SU apk add mandoc man-pages
```

```sh copy
$SU install -D -m 0660 -o elements -g elements ./share/examples/liquid.conf /etc/elements/liquid.conf
```

### Strip installed binaries

```sh copy
$SU strip /usr/bin/elements*
```

### Cleanup

```sh copy
cd
rm -rf /tmp/elements-$VERSION /tmp/SHA256SUMS*
$SU apk del .build-deps
```
</Steps>

## Generate access credentials

For other programs to query Elements they need the proper access credentials. To
avoid storing the username and password in a configuration file in plaintext,
the password is hashed. This allows Elements to accept a password, hash it, and
compare it to the stored hash, while it is not possible to retrieve the original
password.

Another option to get access credentials is through the `.cookie` file in the
Elements data directory. This is created automatically and can be read by all
users who are members of the "elements" group.

Elements provides a simple `python` script to generate the configuration
line for the config file.

But we prefer to do it our way, much more simple

```sh copy
read -r username password; \
[ ! "$username" ] || [ ! "$password" ] && { 
    printf "%s\n" "Error, must provide username and password"
} || {
    sed "s/^#*rpcauth=.*$/rpcauth=${username}:${salt=$(openssl rand -hex 16)}\$$(\
            printf "%s" "${password}" | \
            openssl dgst -sha256 -hmac "$salt" | \
            awk '{print $2}' \
        )/" /etc/elements/liquid.conf > _; \
    unset salt; \
    $SU mv -f _ /etc/elements/liquid.conf
}
```

## Configuration

<Callout type="warning">
`"dbcache=..."` need to be adjusted to your hardware capacity
</Callout>

* Modify/uncomment these lines. Save and exit.

```sh copy
$SU $EDITOR /etc/elements/liquid.conf
```

```nginx filename="/etc/elements/liquid.conf" {2,4,6,8,10,12,14,16-17,19,21,23,25}
[...]
assumevalid=0
[...]
dbcache=8192
[...]
txindex=1
[...]
i2psam=127.0.0.1:7656
[...]
listen=0
[...]
proxy=127.0.0.1:9050
[...]
fallbackfee=0.000001
[...]
debug=i2p
debug=tor
[...]
rpcport=28332
[...]
validatepegin=1
[...]
mainchainrpchost=127.0.0.1
[...]
mainchainrpccookiefile=/var/lib/bitcoind/.cookie
[...]





- -trim_headers=1
# P2P 
- -port=$APP_ELEMENTS_NODE_P2P_PORT
- -blockfilterindex=1
- -peerblockfilters=1
[...]
```

<Callout>
Check this Elements liquid.conf sample
[config](https://github.com/ElementsProject/elements/blob/master/share/examples/liquid.conf)
on web browser
</Callout>

## Create init.d service

The system needs to run the bitcoin daemon automatically in the background, even
when nobody is logged in. We use `openrc`, a daemon that controls the startup
process using configuration files.

* Create the init.d configuration

```sh copy
$SU $EDITOR /etc/init.d/elementsd
```

* Enter the complete next configuration. Save and exit

```nginx copy filename="/etc/init.d/elementsd"
#!/sbin/openrc-run

: ${ELEMENTSD_CONFIGFILE:=/etc/elements/liquid.conf}
: ${ELEMENTSD_DATADIR:=/var/lib/elementsd}
: ${ELEMENTSD_LOGDIR:=/var/log/elementsd}
: ${ELEMENTSD_USER:=elements}
: ${ELEMENTSD_GROUP:=elements}
: ${ELEMENTSD_BIN:=/usr/bin/elementsd}
: ${ELEMENTSD_OPTS=${ELEMENTSD_OPTS}}
: ${ELEMENTSD_SIGTERM_TIMEOUT:=600}

ELEMENTSD_PIDDIR="/run/elementsd"

name="Elements daemon"
description="Bitcoin cryptocurrency P2P network daemon"

required_files="${ELEMENTSD_CONFIGFILE}"
pidfile="${ELEMENTSD_PIDDIR}/${SVCNAME}.pid"
retry="${ELEMENTSD_SIGTERM_TIMEOUT}"

command="${ELEMENTSD_BIN}"
command_args="-pid=${pidfile}
              -conf=${ELEMENTSD_CONFIGFILE}
              -datadir=${ELEMENTSD_DATADIR}
              -debuglogfile=${ELEMENTSD_LOGDIR}/debug.log
              ${ELEMENTSD_OPTS}"
command_args_background="-daemonwait"
command_user="${ELEMENTSD_USER}:${ELEMENTSD_GROUP}"

depend() {
    use net
    need localmount
    checkdepend onion tor
    checkdepend i2psam i2pd
    after logger firewall
}

checkdepend() {
    if grep -qs "^${1}=" "${ELEMENTSD_CONFIGFILE}"; then
        need "${2:-$1}"
    fi
}

start_pre() {
    checkpath --file      --mode 0660 --owner "${command_user}" "${ELEMENTSD_CONFIGFILE}"
    checkpath --directory --mode 0750 --owner "${command_user}" "${ELEMENTSD_DATADIR}"
    checkpath --directory --mode 0755 --owner "${command_user}" "${ELEMENTSD_LOGDIR}"
    checkpath --directory --mode 0755 --owner "${command_user}" "${ELEMENTSD_PIDDIR}"
    checkconfig
}

start_post() {
    chmod -R u=rwX,g=rX,o= "${ELEMENTSD_DATADIR}" "${ELEMENTSD_LOGDIR}"
}

checkconfig() {
    if ! grep -qs '^rpcauth=' "${ELEMENTSD_CONFIGFILE}"
    then
        eerror ""
        eerror "ERROR: You must set a secure rpcauth to run elementsd."
        eerror "The setting must appear in ${ELEMENTSD_CONFIGFILE}"
        eerror ""
        eerror "This auth is security critical to securing wallets "
        eerror "and must not be the same as the rpcuser setting."
        eerror ""
        eerror "It is recommended that you also set alertnotify so you are "
        eerror "notified of problems:"
        eerror ""
        eerror "ie: alertnotify=echo %%s | mail -s \"Bitcoin Alert\"" \
            "admin@foo.com"
        eerror ""
        return 1
    fi
}
```

* Enable execution permission

```sh copy
$SU chmod +x /etc/init.d/elementsd
```

* Enable autoboot

```sh copy
$SU rc-update add elementsd default
```

## Create logrotate config

Logrotate is a system utility that manages the compression and rotation of log
files on Linux systems. If logs are not rotated, compressed, and purged
periodically, they can eventually consume all available disk space on the
system. It allows automatic rotation, compression, removal, and mailing of log
files. Each log file may be handled daily, weekly, monthly, or when it grows too
large.

Normally, logrotate is run as a daily cron job.

* Create the elements logrotate config file

```sh copy
$SU $EDITOR /etc/logrotate.d/elementsd
```

* Enter the complete next configuration. Save and exit

```sh copy filename="/etc/logrotate.d/elementsd"
/var/log/elementsd/*.log {
    weekly
    missingok
    rotate 104
    compress
    delaycompress
    notifempty
    create 0640 elements elements
    sharedscripts
    postrotate
        kill -HUP `cat /run/elementsd.pid`
    endscript
}
```

* Test

```sh copy
$SU logrotate /etc/logrotate.d/elementsd --debug
```

<Callout>
More: [logrotate(8) - Linux man page](https://linux.die.net/man/8/logrotate)
</Callout>

## Run

* Start the service

```sh copy
$SU rc-service elementsd start
```

* Check logs

```sh copy
tail -f /var/log/elementsd/debug.log
```

```sh filename="output"
2024-01-17T13:48:34Z Bitcoin Core version v26.0.0 (release build)
2024-01-17T13:48:34Z InitParameterInteraction: parameter interaction: -blocksonly=1 -> setting -whitelistrelay=0
2024-01-17T13:48:34Z InitParameterInteraction: parameter interaction: -blocksonly=1 -> setting -maxmempool=5
2024-01-17T13:48:34Z Using the 'sse4(1way),sse41(4way),avx2(8way)' SHA256 implementation
2024-01-17T13:48:34Z Using RdSeed as an additional entropy source
2024-01-17T13:48:34Z Using RdRand as an additional entropy source
2024-01-17T13:48:34Z Default data directory /dev/null/.bitcoin
2024-01-17T13:48:34Z Using data directory /var/lib/bitcoind
2024-01-17T13:48:34Z Config file: /etc/bitcoin/bitcoin.conf
2024-01-17T13:48:34Z Config file arg: assumevalid="0"
2024-01-17T13:48:34Z Config file arg: blockfilterindex="1"
2024-01-17T13:48:34Z Config file arg: blocksonly="1"
2024-01-17T13:48:34Z Config file arg: coinstatsindex="1"
2024-01-17T13:48:34Z Config file arg: daemon="1"
2024-01-17T13:48:34Z Config file arg: dbcache="24576"
2024-01-17T13:48:34Z Config file arg: debug="i2p"
2024-01-17T13:48:34Z Config file arg: debug="tor"
2024-01-17T13:48:34Z Config file arg: debuglogfile="/var/log/bitcoind/debug.log"
2024-01-17T13:48:34Z Config file arg: i2psam="127.0.0.1:7656"
2024-01-17T13:48:34Z Config file arg: onion="127.0.0.1:9050"
2024-01-17T13:48:34Z Config file arg: peerblockfilters="1"
2024-01-17T13:48:34Z Config file arg: peerbloomfilters="1"
2024-01-17T13:48:34Z Config file arg: rpcauth=****
2024-01-17T13:48:34Z Config file arg: server="1"
2024-01-17T13:48:34Z Config file arg: startupnotify="chmod -R u=rwX,g=rX,o= /var/lib/bitcoind /var/log/bitcoind"
2024-01-17T13:48:34Z Config file arg: txindex="1"
2024-01-17T13:48:34Z Config file arg: v2transport="1"
2024-01-17T13:48:34Z Command-line arg: conf="/etc/bitcoin/bitcoin.conf"
2024-01-17T13:48:34Z Command-line arg: datadir="/var/lib/bitcoind"
2024-01-17T13:48:34Z Command-line arg: pid="/run/bitcoind/bitcoin.pid"
2024-01-17T13:48:34Z Command-line arg: server=""
[...]
2024-01-17T13:48:46Z Pre-synchronizing blockheaders, height: 2000 (~0.25%)
[...]
```

<Callout type="info">
Monitor the log file for a few minutes to see if it works fine (it may stop at
`dnsseed thread exit`, that's ok)
</Callout>

* Wait a few minutes until Bitcoin Core starts, and enter the next command to
obtain your Tor and I2P addresses. Take note of them, later you might need it

```sh copy
bitcoin-cli getnetworkinfo | grep 'address.*\.onion\|address.*\.i2p'
```

```sh filename="output"
"address": "vctk9tie5srguvz262xpyukkd7g4z2xxxy5xx5ccyg4f12fzop8hoiad.onion",
"address": "sesehks6xyh31nyjldpyeckk3ttpanivqhrzhsoracwqjxtk3apgq.b32.i2p",
```

* Check the correct enablement of the I2P and Tor networks

```sh copy
bitcoin-cli -netinfo
```

```sh filename="output"
Bitcoin Core client v26.0.0 - server 70016/Satoshi:26.0.0/
          ipv4    ipv6   onion   i2p   total   block
in          0       0      25     2      27
out         7       0       2     1      10       2
total       7       0      27     3      37
 
Local addresses
xdtk6tie4srguvz566xpyukkd7m3z3vbby5xx5ccyg5f64fzop7hoiab.onion     port   8333    score      4
etehks3xyh55nyjldjdeckk3nwpanivqhrzhsoracwqjxtk8apgk.b32.i2p       port      0    score      4
```

* Ensure bitcoind is listening on the default RPC & P2P ports

```sh copy
$SU netstat -lntup | grep LISTEN | grep bitcoind
```

```sh filename="output"
tcp        0      0 0.0.0.0:8333            0.0.0.0:*               LISTEN      28295/bitcoind
tcp        0      0 127.0.0.1:8334          0.0.0.0:*               LISTEN      28295/bitcoind
tcp        0      0 127.0.0.1:8332          0.0.0.0:*               LISTEN      28295/bitcoind
tcp        0      0 127.0.0.1:8433          0.0.0.0:*               LISTEN      28295/bitcoind
tcp        0      0 127.0.0.1:28332         0.0.0.0:*               LISTEN      28295/bitcoind
tcp        0      0 127.0.0.1:28333         0.0.0.0:*               LISTEN      28295/bitcoind
tcp        0      0 :::8333                 :::*                    LISTEN      28295/bitcoind
tcp        0      0 ::1:8332                :::*                    LISTEN      28295/bitcoind
```

<Callout type="info">
Please note:

* When `bitcoind` is still starting, you may get an error message like
“verifying blocks”. That’s normal, just give it a few minutes.

* Among other info, the “verificationprogress” is shown. Once this value reaches
almost 1 (0.99999…), the blockchain is up-to-date and fully validated.
</Callout>

## Elements is syncing

This can take between one day and a week, depending mostly on your PC
performance. It's best to wait until the synchronization is complete before
going ahead.

### Explore bitcoin-cli

If everything is running smoothly, this is the perfect time to familiarize
yourself with Bitcoin, the technical aspects of Bitcoin Core, and play around
with `bitcoin-cli` until the blockchain is up-to-date.

* [The Little Bitcoin Book](https://littlebitcoinbook.com) is a fantastic
introduction to Bitcoin, focusing on the "why" and less on the "how".
* [Mastering Bitcoin](https://bitcoinbook.info) by Andreas Antonopoulos is a
great point to start, especially chapter 3 (ignore the first part how to compile
from source code):

    * you definitely need to have a [real copy](https://bitcoinbook.info/) of
    this book!
    * read it online on [GitHub](https://github.com/bitcoinbook/bitcoinbook)

![](/images/bitcoin/client/mastering-bitcoin.webp)

* [Learning Bitcoin from the Command
Line](https://github.com/ChristopherA/Learning-Bitcoin-from-the-Command-Line)
by Christopher Allen gives a thorough deep dive into understanding the technical
aspects of Bitcoin.
* Also, check out the [bitcoin-cli
reference](https://bitcoin.it/wiki/Original\_Bitcoin\_client/API\_calls\_list)

## Activate mempool & reduce 'dbcache' after a full sync

Once Bitcoin Knots **is fully synced**, we can reduce the size of the database
cache. A bigger cache speeds up the initial block download, now we want to
reduce memory consumption to allow the Lightning client and Electrum server to
run in parallel. We also now want to enable the node to listen to and relay
transactions.

* Comment the following lines on `bitcoin.conf` file

<Callout>
Bitcoin Knots will then just use the default cache size of 450 MiB instead of
your setting RAM setup. If `blocksonly=1` is left uncommented it will prevent
Electrum Server from receiving RPC fee data and will not work.
</Callout>

```sh copy
$SU $EDITOR /etc/bitcoin/bitcoin.conf
```

```conf filename="/etc/bitcoin/bitcoin.conf"
#dbcache=2048
#blocksonly=1
#assumevalid=0
```

* Restart Bitcoin Knots for the settings to take effect

```sh copy
$SU rc-service bitcoind restart
```

## Upgrade

The latest release can be found on the [GitHub
page](https://github.com/bitcoinknots/bitcoin/releases/latest) of the Bitcoin
Knots project. Always read the [RELEASE
NOTES](https://github.com/bitcoinknots/bitcoin/tree/master/doc/release-notes)
first! When upgrading, there might be breaking changes or changes in the data
structure that need special attention. Replace the environment variable
`VERSION=x.xx` value for the latest version if it has not been already changed
in this guide.