import { Callout, Steps, Tabs } from 'nextra/components'
import { FAQBox } from '@components'

export const name = "Alby Hub"
export const user = "albyhub"

[security section]: ../system/security#reverse-proxy
[release notes]: https://github.com/getAlby/hub/releases
[{name}]: ./web_app

# Alby Hub

[{name}](https://albyhub.com) is a self-custodial, open source lightning wallet
that connects to apps

![AlbyHub homepage](/images/lightning/webapp/albyHub.webp)

## Preparations

<Steps>
### Install dependencies

These are build dependencies (safe to remove after installation, if you want)

```sh copy
$SU apk add --virtual .build-deps cargo cargo-auditable clang git go yarn
```

These are runtime dependencies

```sh copy
$SU apk add sqlite
```

### Create the {user} user/group

```sh copy
$SU addgroup -S alby
```

```sh copy
$SU adduser \
    -S \
    -D \
    -H \
    -h /dev/null \
    -s /sbin/nologin \
    -G albyhub \
    -g albyhub \
    albyhub
```

### Add {user} user to the lnd group

```sh copy
$SU adduser albyhub lnd
```

### Add satoshi user to the {user} group

```sh copy
$SU adduser satoshi albyhub && exec su -l satoshi
```

### Reverse proxy

In the [security section], we set up a reverse proxy. Now we can add the {name}
configuration.

* Enable the reverse proxy to route external encrypted HTTPS traffic internally
to the {name}.

<Tabs items={['caddy', 'nginx']}>
    <Tabs.Tab>
```sh copy
$SU $EDITOR /etc/caddy/sites/albyhub.caddy
```

```nginx copy filename="/etc/caddy/sites/albyhub.caddy"
:8030 {
        import tls
        reverse_proxy :8029
}
```

* Reload Caddy

```sh copy
$SU rc-service caddy reload
```
    </Tabs.Tab>
    <Tabs.Tab>
```sh copy
$SU $EDITOR /etc/nginx/sites-available/albyhub-reverse-proxy.conf
```

```nginx copy filename="/etc/nginx/sites-available/albyhub-reverse-proxy.conf"
server {
    listen 8030 ssl;

    location / {
        proxy_pass http://127.0.0.1:8029;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

```sh copy
$SU ln \
    -s \
    ../sites-available/albyhub-reverse-proxy.conf \
    /etc/nginx/sites-enabled/albyhub-reverse-proxy.conf
```

* Test and reload NGINX configuration

```sh copy
$SU nginx -t
$SU rc-service nginx restart
```
    </Tabs.Tab>
</Tabs>

### Firewall

* Configure the firewall to allow incoming HTTPS requests

<Tabs items={['awall', 'ufw']}>
    <Tabs.Tab>
```sh copy
$SU $EDITOR /etc/awall/optional/albyhub.json
```

```json copy filename="/etc/awall/optional/albyhub.json"
{
  "description": "Allow Alby Hub SSL",

  "filter": [
    {
      "in": "internet",
      "out": "_fw",
      "service": "albyhub",
      "action": "accept",
      "conn-limit": { "count": 10, "interval": 60 }
    }
  ]
}
```

* Enable it

```sh copy
$SU awall enable albyhub
$SU awall activate
```
    </Tabs.Tab>
    <Tabs.Tab>
```sh copy
$SU ufw limit 8030/tcp comment 'Allow Alby Hub SSL'
```
    </Tabs.Tab>
</Tabs>
</Steps>

## Installation

[{name}](https://albyhub.com) provides a lightweight and easy to use web
interface to accomplish a great node management.

<Steps>
### Increase tmpfs size

```sh copy
$SU mount -o remount,size=8G /tmp
```

### uniffi-bindgen-go

```sh copy
cd /tmp
```

```sh copy
VERSION=v0.2.2+v0.25.0
```

```sh copy
git clone \
    --recurse-submodules \
    --branch $VERSION \
    https://github.com/NordSecurity/uniffi-bindgen-go && \
cd uniffi-bindgen-go
```

```sh copy
cargo auditable build \
    --bin uniffi-bindgen-go \
    --release \
    --locked \
    --jobs "$(nproc)"
```
  
```sh copy
install -Dm755 target/release/uniffi-bindgen-go /tmp/bin/uniffi-bindgen-go
```

```sh copy
cd /tmp
rm -rf uniffi-bindgen-go
```

### breez-sdk-go

```sh copy
cd /tmp
```

```sh copy
VERSION=0.5.2
```

```sh copy
git clone --branch $VERSION https://github.com/breez/breez-sdk-greenlight.git && cd breez-sdk-greenlight/libs/sdk-bindings
```
  
```sh copy
/tmp/bin/uniffi-bindgen-go src/breez_sdk.udl \
    --out-dir ffi/golang \
    --config ./uniffi.toml
```

```sh copy
cargo build \
    --release \
    --jobs "$(nproc)"
```
  
```sh copy
install -Dm444 ../target/release/libbreez_sdk_bindings.so /tmp/nwc/libbreez_sdk_bindings.so
```

```sh copy
cd /tmp
rm -rf breez-sdk-greenlight
```

### glalby-go

```sh copy
cd /tmp
```

```sh copy
git clone https://github.com/getAlby/glalby.git && cd glalby
```

```sh copy
/tmp/bin/uniffi-bindgen-go src/glalby.udl \
    --out-dir . \
    --config ./uniffi.toml
```

```sh copy
cargo build \
    --release \
    --jobs "$(nproc)"
```

```sh copy
install -Dm444 ./target/release/libglalby_bindings.so /tmp/nwc/libglalby_bindings.so
```

```sh copy
cd /tmp
rm -rf glalby
```

### ldk-node-go

```sh copy
cd /tmp
```

```sh copy
git clone https://github.com/getAlby/ldk-node.git && cd ldk-node
```

```sh copy
git checkout 9c1e2aa3536f5b8e034e6567a6ba6d3eb1c41667
```

```sh copy
/tmp/bin/uniffi-bindgen-go bindings/ldk_node.udl \
    --out-dir ffi/golang \
    --config ./uniffi.toml
```

```sh copy
cargo build \
    --release \
    --features uniffi \
    --jobs "$(nproc)"
```

```sh copy
install -Dm444 ./target/release/libldk_node.so /tmp/nwc/libldk_node.so
```

```sh copy
cd /tmp
rm -rf ldk-node
```

### Download source code

We get the latest release of the {name} source code and install it.

* Download the source code for the latest {name} release. You can check the
[release notes] to see if a newer release is available. Other releases might not
have been properly tested with the rest of the Microbolt configuration, though.

```sh copy
cd /tmp
```

```sh copy
VERSION=1.10.4
```

```sh copy
git clone --branch v$VERSION https://github.com/getAlby/hub.git && cd hub
```

### Build, compile and install

* Install all frontend dependencies using Yarn Package Manager (yarn).

```sh copy
yarn --cwd ./frontend install
```

Installation can take some time. There might be a lot of confusing output, but
if you see something similar to the following, the installation was successful:

```sh filename="output"
[...]
âœ“ built in 10.20s

PWA v0.20.1
mode      generateSW
precache  10 entries (2201.53 KiB)
```

```sh copy
yarn --cwd ./frontend build:http
```

* Make it a global permanent installation

```sh copy
go mod download
```

```sh copy
install -Dm444 /tmp/breez-sdk-greenlight/libs/target/release/libbreez_sdk_bindings.so \
    "/tmp/go/pkg/mod/github.com/breez/breez-sdk-go@v0.5.2/breez_sdk/lib/linux-${ARCH//arm64/aarch64}/libbreez_sdk_bindings.so"
```

```sh copy
install -Dm444 /tmp/glalby/target/release/libglalby_bindings.so \
    "/tmp/go/pkg/mod/github.com/get!alby/glalby-go@v0.0.0-20240621192717-95673c864d59/glalby/${ARCH//amd64/x86_64}-unknown-linux-gnu/libglalby_bindings.so"
```

```sh copy
install -Dm444 /tmp/ldk-node/target/release/libldk_node.so \
    "/tmp/go/pkg/mod/github.com/get!alby/ldk-node-go@v0.0.0-20240924080718-27f0fdd2a75d/ldk_node/${ARCH//amd64/x86_64}-unknown-linux-gnu/libldk_node.so"
```

```sh copy
go build \
    -ldflags="-X 'github.com/getAlby/hub/version.Tag=v$VERSION'" \
    -o albyhub \
    cmd/http/main.go
```

* Install {name} files

```sh copy
$SU install -Dm0755 albyhub /usr/bin/albyhub
```

```sh copy
$SU install -Dm0755 /tmp/nwc/libbreez_sdk_bindings.so /usr/lib/nwc/libbreez_sdk_bindings.so
$SU install -Dm0755 /tmp/nwc/libglalby_bindings.so    /usr/lib/nwc/libglalby_bindings.so
$SU install -Dm0755 /tmp/nwc/libldk_node.so           /usr/lib/nwc/libldk_node.so
```

```sh copy
$SU install -Dm0660 -u albyhub -g albyhub ./.env.example /etc/albyhub/mainnet.env
```

### Cleanup

```sh copy
cd
rm -rf /tmp/*
$SU apk del .build-deps
```
</Steps>

## Configuration

* Edit the configuration file

```sh copy
$SU $EDITOR /etc/albyhub/mainnet.env
```

```sh filename="/etc/albyhub/mainnet.env"
[...]
things
[...]
```

<FAQBox title="Remote access over Tor">
* Add the following lines in the section "location hidden services" in the
`torrc` file.

```sh copy
$SU $EDITOR /etc/tor/torrc
```

```conf copy filename="/etc/tor/torrc"
# Hidden Service Alby Hub
HiddenServiceDir /var/lib/tor/albyhub/
HiddenServiceVersion 3
HiddenServicePoWDefensesEnabled 1
HiddenServicePort 443 127.0.0.1:8029
```

* Reload Tor configuration and get your connection address.

```sh copy
$SU rc-service tor reload
$SU cat /var/lib/tor/albyhub/hostname
```

```sh filename="output"
abcdefg..............xyz.onion
```

* You should now be able to connect to your Alby Hub remotely via Tor using
your hostname
</FAQBox>

### Autostart on boot

Now we'll make sure our lightning node manager starts as a service on the
computer so that it's always running.

* Create the {name} init.d unit and copy/paste the following configuration.
Save and exit.

```sh copy
$SU $EDITOR /etc/init.d/albyhub
```

```sh copy filename="/etc/init.d/albyhub"
#!/sbin/openrc-run

: ${ALBYHUB_CONFIGFILE:=/etc/albyhub/mainnet.env}
: ${ALBYHUB_DATADIR:=/var/lib/albyhub}
: ${ALBYHUB_LOGDIR:=/var/log/albyhub}
: ${ALBYHUB_USER:=albyhub}
: ${ALBYHUB_GROUP:=albyhub}
: ${ALBYHUB_BIN:=/usr/bin/albyhub}
: ${ALBYHUB_OPTS=${ALBYHUB_OPTS}}
: ${ALBYHUB_SIGTERM_TIMEOUT:=600}

ALBYHUB_PIDDIR="/run/albyhub"

name="Alby Hub"
description="A self-custodial, open source lightning wallet that connects to apps"

directory="${ALBYHUB_DATADIR}"
required_files="${ALBYHUB_CONFIGFILE}"
pidfile="${ALBYHUB_PIDDIR}/${SVCNAME}.pid"
retry="${ALBYHUB_SIGTERM_TIMEOUT}"

command="${ALBYHUB_BIN}"
command_args="${ALBYHUB_OPTS}"
command_user="${ALBYHUB_USER}:${ALBYHUB_GROUP}"
command_background="true"

start_stop_daemon_args="--stdout ${ALBYHUB_LOGDIR}/debug.log
                        --stderr ${ALBYHUB_LOGDIR}/debug.log"

depend() {
    after net
    need lnd
}

start_pre() {
    checkpath --file      --mode 0660 --owner "${command_user}" "${ALBYHUB_CONFIGFILE}"
    checkpath --directory --mode 0750 --owner "${command_user}" "${ALBYHUB_DATADIR}"
    checkpath --directory --mode 0755 --owner "${command_user}" "${ALBYHUB_LOGDIR}"
    checkpath --directory --mode 0755 --owner "${command_user}" "${ALBYHUB_PIDDIR}"
    checkconfig
}

checkconfig() {
    if ! grep -qs '^    macaroonPath: ' "${ALBYHUB_CONFIGFILE}"
    then
        eerror ""
        eerror "ERROR: You must set a macaroonPath path to run AlbyHub"
        eerror "The setting must appear in ${ALBYHUB_CONFIGFILE}"
        eerror ""
        return 1
    fi
}
```

* Enable execution permission

```sh copy
$SU chmod +x /etc/init.d/albyhub
```

### Enable logrotate

* Enter the complete next configuration. Save and exit

```sh copy
$SU $EDITOR /etc/logrotate.d/albyhub
```

```sh copy filename="/etc/logrotate.d/albyhub"
/var/log/albyhub/*.log {
    weekly
    missingok
    rotate 104
    compress
    delaycompress
    notifempty
    create 0640 albyhub albyhub
    sharedscripts
    postrotate
        kill -HUP `cat /run/albyhub/albyhub.pid`
    endscript
}
```

* Test

```sh copy
$SU logrotate /etc/logrotate.d/albyhub --debug
```

## Enable and start {name}

```sh copy
$SU rc-update add albyhub
```

```sh copy
$SU rc-service albyhub start
```

<Callout emoji="ðŸŽ‰">
**Congratulations!** You now have Albyhub up and running
</Callout>

* Check the log to see Albyhub output. Exit with `Ctrl-C`

```sh copy
tail -f /var/log/albyhub/debug.log
```

You can now access {name} from within your local network by browsing to
https://nakamoto01:4002, https://nakamoto01.local:4002 (or your equivalent ip
address).

## For the future: {name} update

Follow again [{name}] page replacing the environment variable `VERSION=x.xx`
value for the latest if it has not been already changed in this guide.

* Update the {name} configuration if necessary (see [release notes])

```sh copy
$SU $EDITOR /etc/albyhub/mainnet.env
```

* Restart the service to apply the changes

```sh copy
$SU rc-service albyhub restart
```