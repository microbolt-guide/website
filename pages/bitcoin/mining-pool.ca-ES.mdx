import { Callout, Steps, Tabs } from 'nextra/components'
import { FAQBox } from '@components'

# Mining Pool

Executa la teva pr貌pia piscina minera privada amb [Public
Pool](https://github.com/benjamin-wilson/public-pool).

![Pagina principal de Public Pool](/img/bitcoin/mining-pool/publicpool-homepage.webp)

## Executa la teva pr貌pia piscina minera

Despr茅s que Microbolt executi el teu propi node totalment validat, actu茂 com a
backend per al teu dispositiu de signatura de maquinari amb el servidor
Electrum, puguis explorar la cadena de blocs en un navegador web, la darrera
pe莽a important del trencaclosques per millorar la privadesa i la sobirania
financera 茅s la teva pr貌pia piscina minera.
Et permet connectar el teu propi [nerdminer](https://bitronics.store) i/o
[bitaxe](https://bitaxe.org) al teu Microbolt i intentar "trobar" un bloc a la
Solo Bitcoin Mining Pool. Ja no necessites filtrar informaci贸 de la teva
velocitat de hash a una piscina minera de tercers.

## Preparatius

<Steps>
### Instal路leu depend猫ncies

* Instal路leu Node.js mitjan莽ant el gestor de paquets apk.

Aquestes s贸n depend猫ncies de creaci贸 (es pot eliminar despr茅s de la
instal路laci贸, si voleu)

```sh copy
$SU apk add npm
```

Aquestes s贸n depend猫ncies en temps d'execuci贸

```sh copy
$SU apk add nodejs-current
```

### Creeu l'usuari/grup `public-pool`

```sh copy
$SU addgroup -S public-pool
```

```sh copy
$SU adduser \
    -S \
    -D \
    -H \
    -h /dev/null \
    -s /sbin/nologin \
    -G public-pool \
    -g public-pool \
    public-pool
```

### Afegeix l'usuari `public-pool` al grup `bitcoin`

```sh copy
$SU adduser public-pool bitcoin
```

### Afegiu tamb茅 l'usuari `satoshi` al grup `public-pool`

```sh copy
$SU adduser satoshi public-pool
```

### Servidor intermediari invers

A la secci贸 de [Seguretat](/system/security#servidor-intermediari-invers), hem
configurat un servidor intermediari invers. Ara podem afegir la configuraci贸 de
Public Pool.

* Habilita el servidor intermediari invers per encaminar el trnsit HTTPS extern
xifrat internament cap a Public Pool

<Tabs items={['caddy', 'nginx']}>
    <Tabs.Tab>
```sh copy
$SU $EDITOR /etc/caddy/public-pool.caddy
```

```caddy copy filename="/etc/caddy/public-pool.caddy"
:4040 {
    root * /var/www/public-pool-ui
    file_server

    try_files {path} {path}/ =404

    handle_path /api/* {
        reverse_proxy 127.0.0.1:23334
    }
}
```

* Torna a carregar el Caddy

```sh copy
$SU rc-service caddy restart
```
    </Tabs.Tab>
    <Tabs.Tab>
```sh copy
$SU $EDITOR /etc/nginx/sites-available/public-pool-reverse-proxy.conf
```

```nginx copy filename="/etc/nginx/sites-available/public-pool-reverse-proxy.conf"
server {
    listen 4040 ssl;

    root /var/www/public-pool-ui;

    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }

    location ~* ^/api/ {
        proxy_pass http://127.0.0.1:23334;
    }
}
```

```sh copy
$SU ln \
    -s \
    ../sites-available/public-pool-reverse-proxy.conf \
    /etc/nginx/sites-enabled/public-pool-reverse-proxy.conf
```

* Prova i torna a carregar la configuraci贸 de NGINX

```sh copy
$SU nginx -t
$SU rc-service nginx restart
```
    </Tabs.Tab>
</Tabs>

### Firewall

* Configura el tallafoc per permetre les sol路licituds HTTPS entrants

<Tabs items={['awall', 'ufw']}>
    <Tabs.Tab>
```sh copy
$SU $EDITOR /etc/awall/optional/pool-ui.json
```

```json copy filename="/etc/awall/optional/pool-ui.json"
{
  "description": "Allow Public Pool UI SSL",

  "filter": [
    {
      "in": "internet",
      "out": "_fw",
      "service": { "proto": "tcp", "port": 4040 },
      "action": "accept",
      "conn-limit": { "count": 10, "interval": 60 }
    }
  ]
}
```

```sh copy
$SU $EDITOR /etc/awall/optional/pool-stratum.json
```

```json copy filename="/etc/awall/optional/pool-stratum.json"
{
  "description": "Allow Public Pool Stratum",

  "filter": [
    {
      "in": "internet",
      "out": "_fw",
      "service": { "proto": "tcp", "port": 23333 },
      "action": "accept",
      "conn-limit": { "count": 10, "interval": 60 }
    }
  ]
}
```

* Habilitar-ho

```sh copy
$SU awall enable pool-ui pool-stratum
$SU awall activate
```
    </Tabs.Tab>
    <Tabs.Tab>
```sh copy
$SU ufw limit 4040/tcp comment 'Allow Public Pool UI SSL'
$SU ufw limit 23333/tcp comment 'Allow Public Pool Stratum'
```
    </Tabs.Tab>
</Tabs>

### Modificar els indicadors de node

```sh copy
printf "%s\n" \
    "export npm_config_cache=\"./npm-cache\"" \
    "export npm_config_devdir=\"./.gyp\"" \
    | $SU tee -a /etc/profile.d/node.sh
```

```sh copy
. /etc/profile.d/node.sh
```
</Steps>

## Instal路laci贸

[Public Pool](https://github.com/benjamin-wilson/public-pool) proporciona una
interf铆cie web lleugera i fcil d'utilitzar per aconseguir just aix貌: una
piscina minera en solitari.

<Steps>
### Descarrega el codi font del servidor

Obtenim l'煤ltim commit del codi font del servidor Public Pool i l'instal路lem.

* Baixa el codi font de l'煤ltim commit del servidor Public Pool. Pots consultar
la [release page](https://github.com/benjamin-wilson/public-pool/releases) per
veure si hi ha una versi贸 m茅s nova disponible. No obstant aix貌, altres versions
podrien no haver estat provades adequadament amb la resta de la configuraci贸 de
Microbolt.

```sh copy
cd /tmp
```

```sh copy
git clone https://github.com/benjamin-wilson/public-pool.git && cd public-pool
```

### Configura i instal路la

* Instal路leu totes les depend猫ncies mitjan莽ant el Node Package Manager (NPM).

```sh copy
npm install
npm audit fix
```

La instal路laci贸 pot trigar un temps. Pot ser que hi hagi moltes sortides
confuses, per貌 si veieu alguna cosa semblant a la seg眉ent, la instal路laci贸 ha
estat correcta:

<Callout type="warning">
A data de `2024-03-18`, hi ha com a m铆nim **8 vulnerabilitats moderades** que no
es poden abordar sense fer canvis substancials que podrien afectar altres parts
del programari

```sh copy
npm audit fix --force
```
</Callout>

```output filename="output"
8 moderate severity vulnerabilities
 
To address issues that do not require attention, run:
  npm audit fix
 
To address all issues possible (including breaking changes), run:
  npm audit fix --force
 
Some issues need review, and may require choosing
a different dependency.
```

* Feu-ne una instal路laci贸 permanent global

```sh copy
mkdir ./bin
```

```sh copy
printf "%s\n" \
    "#!/bin/sh" \
    "./node_modules/.bin/nest start --config ./nest-cli.json" \
    > ./bin/cli.sh
```

```sh copy
chmod +x ./bin/cli.sh
```

```sh copy
$SU install -D -m 0660 -o public-pool -g public-pool ./.env.example /etc/public-pool/.env
```

```sh copy
$SU mv -f /tmp/public-pool /var/lib/
```

```sh copy
$SU ln -s /etc/public-pool/.env /var/lib/public-pool/.env
$SU ln -s /var/lib/public-pool /usr/lib/node_modules/public-pool
$SU ln -s ../lib/node_modules/public-pool/bin/cli.sh /usr/bin/public-pool
```
</Steps>

---

<Steps>
### Descarrega el codi font del client

Obtenim l'煤ltim commit del codi font del servidor Public Pool i l'instal路lem.

* Baixa el codi font de l'煤ltim commit del servidor Public Pool. Pots consultar
la [release page](https://github.com/benjamin-wilson/public-pool-ui/releases)
per veure si hi ha una versi贸 m茅s nova disponible. No obstant aix貌, altres
versions podrien no haver estat provades adequadament amb la resta de la
configuraci贸 de Microbolt.

```sh copy
cd /tmp
```

```sh copy
git clone https://github.com/benjamin-wilson/public-pool-ui.git && cd public-pool-ui
```

### Configura i instal路la

* Instal路leu totes les depend猫ncies mitjan莽ant el Node Package Manager (NPM).

```sh copy
npm install
npm audit fix
```

<Callout type="warning">
A data de `2024-03-06`, hi ha com a m铆nim **8 vulnerabilitats (5 moderades, 2
altes, 1 critica)** que no es poden abordar sense fer canvis substancials que
podrien afectar altres parts del programari

```sh copy
npm audit fix --force
```
</Callout>

La instal路laci贸 pot trigar un temps. Pot ser que hi hagi moltes sortides
confuses, per貌 si veieu alguna cosa semblant a la seg眉ent, la instal路laci贸 ha
estat correcta:

```output filename="output"
npm WARN deprecated uuid@2.0.3: Please upgrade  to version 7 or higher.  Older versions may use Math.random() in certain circumstances, which is known to be problematic.  See https://v8.dev/blog/math-random for details.
 
added 1040 packages, and audited 1041 packages in 10s
 
144 packages are looking for funding
  run `npm fund` for details
 
8 vulnerabilities (5 moderate, 2 high, 1 critical)
 
To address all issues, run:
  npm audit fix
 
Run `npm audit` for details.
```

* Feu-ne una instal路laci贸 permanent global

```sh copy
printf "%s\n" \
    "export const environment = {" \
    "    production: true," \
    "    API_URL: 'https://nakamoto01.local:4040'," \
    "    STRATUM_URL: 'nakamoto01.local:23333'" \
    "};" \
    > ./src/environments/environment.prod.ts
```

```sh copy
npm run build
```

```sh copy
$SU mv -f ./dist/public-pool-ui /var/www/
```
</Steps>

## Configuraci贸

* Activa qualsevol configuraci贸 retirant el `#` del principi de la l铆nia.

```sh copy
$EDITOR /etc/public-pool/.env
```

```sh filename="/etc/public-pool/.env"
[...]
BITCOIN_RPC_URL=http://127.0.0.1
[...]
BITCOIN_RPC_USER=microbolt
BITCOIN_RPC_PASSWORD="[ B ] Bitcoin RPC password"
BITCOIN_RPC_PORT=8332
[...]
BITCOIN_ZMQ_HOST="tcp://127.0.0.1:28332"
[...]
API_PORT=23334
STRATUM_PORT=23333
[...]
NETWORK=mainnet
[...]
ENABLE_SOLO=true
ENABLE_PROXY=false
[...]
```

<FAQBox title="Acc茅s remot a l'interficie web per Tor">
* Afegiu les l铆nies seg眉ents a la secci贸 de "location-hidden services" al fitxer
`torrc`.

```sh copy
$SU $EDITOR /etc/tor/torrc
```

```sh copy filename="/etc/tor/torrc"
# Hidden Service Public Pool
HiddenServiceDir /var/lib/tor/public-pool/
HiddenServiceVersion 3
HiddenServicePoWDefensesEnabled 1
HiddenServicePort 80 127.0.0.1:4040
```

* Torneu a carregar la configuraci贸 de Tor i obteniu la vostra adre莽a de
connexi贸.

```sh copy
$SU rc-service tor reload
$SU cat /var/lib/tor/public-pool/hostname
```

```output filename="output"
abcdefg..............xyz.onion
```


* Ara hauries de poder connectar-te de forma remota al teu Public Pool a trav茅s
de Tor utilitzant el teu nom d'amfitri贸
</FAQBox>

### Inici automtic a l'arrencada

Ara ens assegurarem que el nostre Public Pool s'inici茂 com a servei a
l'ordinador perqu猫 estigui sempre en execuci贸.

* Creeu la unitat init.d de Public Pool i copieu/enganxeu la configuraci贸
seg眉ent. Guardar i sortir.

```sh copy
$SU $EDITOR /etc/init.d/public-pool
```

```sh copy filename="/etc/init.d/public-pool"
#!/sbin/openrc-run

: ${PUBLICPOOL_CONFIGFILE:=/etc/public-pool/.env}
: ${PUBLICPOOL_WEBUI:=/var/www/public-pool-ui}
: ${PUBLICPOOL_DATADIR:=/var/lib/public-pool}
: ${PUBLICPOOL_LOGDIR:=/var/log/public-pool}
: ${PUBLICPOOL_USER:=public-pool}
: ${PUBLICPOOL_GROUP:=public-pool}
: ${PUBLICPOOL_BIN:=/usr/bin/public-pool}
: ${PUBLICPOOL_OPTS=${PUBLICPOOL_OPTS}}
: ${PUBLICPOOL_SIGTERM_TIMEOUT:=600}

PUBLICPOOL_PIDDIR="/run/public-pool"

directory="${PUBLICPOOL_DATADIR}"
required_files="${PUBLICPOOL_CONFIGFILE}"
pidfile="${PUBLICPOOL_PIDDIR}/${SVCNAME}.pid"

name="Public Pool"
description="Fully Open Source Solo Bitcoin Mining Pool"

command="${PUBLICPOOL_BIN}"
command_args="${PUBLICPOOL_OPTS}"
command_user="${PUBLICPOOL_USER}:${PUBLICPOOL_GROUP}"
command_background="true"

start_stop_daemon_args="--stdout ${PUBLICPOOL_LOGDIR}/debug.log
                        --stderr ${PUBLICPOOL_LOGDIR}/debug.log"

depend() {
    need bitcoind
}

start_pre() {
    checkpath --file      --mode 0660 --owner "${command_user}" "${PUBLICPOOL_CONFIGFILE}"
    checkpath --directory --mode 0750 --owner "${command_user}" "${PUBLICPOOL_DATADIR}"
    checkpath --directory --mode 0755 --owner "${command_user}" "${PUBLICPOOL_LOGDIR}"
    checkpath --directory --mode 0755 --owner "${command_user}" "${PUBLICPOOL_PIDDIR}"
    checkpath --directory --mode 0755 --owner "${command_user}" "${PUBLICPOOL_WEBUI}"
    checkconfig
}

start_post() {
    checkpath --file --owner "${command_user}" "${pidfile}"
    chown -R "${command_user}" "${PUBLICPOOL_WEBUI}"
}

checkconfig() {
    if ! grep -qs '^BITCOIN_RPC_USER='     "${PUBLICPOOL_CONFIGFILE}" &&
       ! grep -qs '^BITCOIN_RPC_PASSWORD=' "${PUBLICPOOL_CONFIGFILE}"
    then
        eerror ""
        eerror "ERROR: You must set a BITCOIN_RPC_USER and"
        eerror "BITCOIN_RPC_PASSWORD path to run Public pool."
        eerror "The setting must appear in ${PUBLICPOOL_CONFIGFILE}"
        eerror ""
        return 1
    fi
}

stop() {
    ebegin "Stopping ${SVCNAME}"
    pkill -TERM -P "$(pgrep -P $(cat ${pidfile}))"
    start-stop-daemon \
        --stop \
        --pidfile="${pidfile}" \
        --retry="${PUBLICPOOL_SIGTERM_TIMEOUT}" \
        --exec="${PUBLICPOOL_BIN}"
    eend $?
}
```

* Habilita el perm铆s d'execuci贸

```sh copy
$SU chmod +x /etc/init.d/public-pool
```

### Habilita logrotate

* Introdu茂u la configuraci贸 seg眉ent completa. Guardar i sortir

```sh copy
$SU $EDITOR /etc/logrotate.d/public-pool
```

```sh copy filename="/etc/logrotate.d/public-pool"
/var/log/public-pool/*.log {
    weekly
    missingok
    rotate 104
    compress
    delaycompress
    notifempty
    create 0640 public-pool public-pool
    sharedscripts
    postrotate
        killall -HUP `cat /run/public-pool/public-pool.pid`
    endscript
}
```

* Prova

```sh copy
$SU logrotate /etc/logrotate.d/public-pool --debug
```

## Activa i inicia Public Pool

```sh copy
$SU rc-update add public-pool
$SU rc-service public-pool start

```

<Callout emoji="">
**Felicitats!** Ara tens Public Pool funcionant
</Callout>

* Comproveu el registre per veure la sortida de Public Pool. Sortiu amb `Ctrl-C`

```sh copy
tail -f /var/log/public-pool/debug.log
```

* Ara pots accedir a Public Pool des de la teva xarxa local navegant a
https://nakamoto01:4040, https://nakamoto01.local:4040 (o la teva adre莽a IP
equivalent).

## Per al futur: actualitzaci贸 de Public Pool

<Callout type="warning">
No hi ha cap versi贸 existent de public-pool encara, aix铆 que actualitza-la quan
hagi passat prou temps o segueix el projecte per veure si hi ha alguna novetat
interessant
</Callout>

Torneu a seguir la pgina [Pool de Mineria](./mining-pool) substituint el valor
de la variable d'entorn `VERSION=x.xx` per l'煤ltim si encara no s'ha modificat
en aquesta guia.

* Actualitzeu la configuraci贸 de Public Pool si cal (vegeu les notes de la
versi贸)

```sh copy
$SU $EDITOR /etc/public-pool/.env
```

* Reinicieu el servei per aplicar els canvis

```sh copy
$SU rc-service public-pool restart
```